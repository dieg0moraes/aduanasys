# Supabase Local Development Environment

## Goal

Set up a local Supabase instance via CLI so developers can test changes without impacting the production database.

## Approach

Use Supabase CLI (`supabase start`) to run a full local stack (Postgres + pgVector + Auth + Storage + Realtime) via Docker.

## What gets created

| File | Purpose |
|------|---------|
| `supabase/config.toml` | Supabase CLI project config (generated by `supabase init`) |
| `supabase/migrations/00000000000000_initial.sql` | Consolidated schema (schema.sql + all incremental migrations) |
| `supabase/seed.sql` | Loads NCM nomenclator from CSV into local DB |
| `.env.development.local` | Supabase local URLs/keys for `npm run dev` |

## Schema consolidation order

1. `schema.sql` — base tables, enums, indexes, RLS, RPC functions
2. `update-vector-1536.sql` — migrate vectors to 1536 dims, recreate HNSW indexes + RPCs
3. `add-fulltext-trigram.sql` — tsvector columns, trigram indexes, fulltext RPCs
4. `enable-realtime.sql` — realtime publication for invoices
5. `add-clients-despachos.sql` — clients + despachos tables
6. `add-catalog-fields.sql` — latu, imesi, exonera_iva, apertura columns
7. `add-despacho-documents.sql` — despacho_documents table + storage bucket
8. `add-internal-description.sql` — internal_description column
9. `add-invoice-country.sql` — country_code column on invoices

## Environment switching

- `npm run dev` loads `.env.development.local` automatically (Next.js convention)
- `.env.development.local` points to `http://127.0.0.1:54321` (local Supabase)
- `.env.local` keeps production credentials (loaded only when `.env.development.local` is absent)

## Daily workflow

```bash
supabase start        # Start local DB
npm run dev           # Dev server uses local Supabase
supabase stop         # Stop when done
supabase db reset     # Reset to clean schema + seed
```
